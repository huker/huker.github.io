<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>react-native热更新集成(使用CodePush) | 回头看看</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">react-native热更新集成(使用CodePush)</h1><a id="logo" href="/.">回头看看</a><p class="description">keep moving</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">react-native热更新集成(使用CodePush)</h1><div class="post-meta">May 16, 2019</div><div class="post-content"><p>终于要集成下rn的热更新了，这边挑选了微软的CodePush服务<a href="https://microsoft.github.io/code-push/" target="_blank" rel="external">https://microsoft.github.io/code-push/</a></p>
<p>首先列一下大体步骤：</p>
<ul>
<li>本地安装CodePush cli</li>
<li>注册CodePush账号</li>
<li>把要接入的项目加入到你的CodePush中</li>
<li>项目中安装CodePush sdk</li>
<li>加入集成的代码</li>
<li>发布更新版本来测试</li>
</ul>
<blockquote>
<p>上面的1 2 3步骤下面各种教程都有，就只粗略写一下，重点写具体项目集成的</p>
</blockquote>
<h3 id="1、2-安装注册"><a href="#1、2-安装注册" class="headerlink" title="1、2 安装注册"></a>1、2 安装注册</h3><p>本地安装CodePush cli:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g code-push-cli</div></pre></td></tr></table></figure>
<p>注册账号：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">code-push register</div></pre></td></tr></table></figure>
<p>如果直接在官网注册了，输入这个会弹出来token，复制到命令行就ok了</p>
<h3 id="3-把要接入的项目加入到你的CodePush中"><a href="#3-把要接入的项目加入到你的CodePush中" class="headerlink" title="3 把要接入的项目加入到你的CodePush中"></a>3 把要接入的项目加入到你的CodePush中</h3><p>要把项目的安卓和ios都分别添加进去</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ios添加</span></div><div class="line">code-push app add iOSApp ios react-native</div><div class="line"></div><div class="line"><span class="comment">//android添加</span></div><div class="line">code-push app add androidApp android react-native</div></pre></td></tr></table></figure>
<p>每个app添加的时候，都会输出它的deployment key的表格，Staging和Production，复制下来备用。可以测试用Staging，线上用Production，用哪个都行，后面集成的时候对应好可以。</p>
<p>添加完可以用下面命令查看你添加了哪些app(官网上登录了也可以看到):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">code-push app list</div></pre></td></tr></table></figure>
<h3 id="4-在项目中安装CodePush-sdk"><a href="#4-在项目中安装CodePush-sdk" class="headerlink" title="4 在项目中安装CodePush sdk"></a>4 在项目中安装CodePush sdk</h3><p>首先安装和link，和别的插件步骤一样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//安装</span></div><div class="line">npm install react-native-code-push --save</div><div class="line"><span class="comment">//link</span></div><div class="line">react-native link react-native-code-push</div></pre></td></tr></table></figure>
<p>link的时候，会提示让你输入deploymentKey，这个key就是上面添加app后输出的那个表格，选你要的环境的key就好(比如用Staging的话，安卓、ios都输入Staging的key)</p>
<p>link好了之后去看下两个地方：</p>
<ul>
<li><p>ios的info.plist中CodePushDeploymentKey有没有成功加进去，没有就自己手加下</p>
</li>
<li><p>android里android/app/src/main/java/com/…(你app的名字)/MainApplication.java这文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//...(各种引入太长了省略)</span></div><div class="line"><span class="comment">//新添加的</span></div><div class="line"><span class="keyword">import</span> com.microsoft.codepush.react.CodePush;</div><div class="line"><span class="comment">//...(各种引入太长了省略)</span></div><div class="line">  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> <span class="keyword">extends</span> <span class="title">NavigationApplication</span> </span>&#123;</div><div class="line">    <span class="comment">//新添加的这个getJSBundleFile重写</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getJSBundleFile</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> CodePush.getJSBundleFile();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDebug</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> BuildConfig.DEBUG;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">protected</span> List&lt;ReactPackage&gt; <span class="title">getPackages</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Arrays.&lt;ReactPackage&gt;asList(</div><div class="line">                <span class="keyword">new</span> RNCameraPackage(),</div><div class="line">                <span class="keyword">new</span> SplashScreenReactPackage(),</div><div class="line">                <span class="keyword">new</span> RNVersionNumberPackage(),</div><div class="line">                <span class="comment">//新添加的</span></div><div class="line">                <span class="keyword">new</span> CodePush(<span class="string">"h42yJwZPRwunc2KwitUiHZxvNHrda7eba4ac-fdd0-4f23-8f78-1b82ff7d5664"</span>,getApplicationContext(),BuildConfig.DEBUG)</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;ReactPackage&gt; <span class="title">createAdditionalReactPackages</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> getPackages();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getJSMainModuleName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"index"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="5-集成"><a href="#5-集成" class="headerlink" title="5 集成"></a>5 集成</h3><p>(这块我也不是很确定我这样的思路是不是正确的，没有去找教程之类的参考，所以如果有问题或者有更好的解决方式，麻烦指教下~)</p>
<p>首先在App的外面用codepush包起来，配置为手动更新。checkFrequency可以设置更新的方式，如果是自动的话就会自己检测然后下载，静默的，我这边的需求是要提示页面的所以走手动。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> codePush <span class="keyword">from</span> <span class="string">"react-native-code-push"</span>;</div><div class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">"./App"</span>;</div><div class="line"></div><div class="line"><span class="keyword">let</span> codePushOptions = &#123; checkFrequency: codePush.CheckFrequency.MANUAL &#125;;</div><div class="line"><span class="keyword">const</span> AppContainer = codePush(codePushOptions)(App);</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> AppContainer;</div></pre></td></tr></table></figure>
<p>首先我项目中用了react-native-navigation，所以为了拎出来做这块就把热更新的承载页面也作为一个root route。在注册玩所有route后，先检查一下有没有更新版本，有就先render到热更新承载页，再进入具体的更新相关的操作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//...为了篇幅 省略各种import</span></div><div class="line"></div><div class="line">appRoot = <span class="string">'loading'</span>;</div><div class="line"><span class="keyword">let</span> &#123; store &#125; = configStore();</div><div class="line">registerTabs(store, Provider);</div><div class="line">handleUpdate();</div><div class="line"></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">handleUpdate</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    CodePush.notifyAppReady();</div><div class="line">    <span class="keyword">const</span> updateMessage = <span class="keyword">await</span> CodePush.checkForUpdate() || &#123;&#125;;</div><div class="line">    <span class="keyword">if</span> (updateMessage &amp;&amp; !lodash.isEmpty(updateMessage)) &#123;</div><div class="line">        <span class="keyword">this</span>.appRoot = <span class="string">'hot'</span>;</div><div class="line">        renderType();</div><div class="line">        store.subscribe(onStoreUpdateHot)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        checkToken();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkToken</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> token = <span class="literal">null</span>;</div><div class="line">    <span class="keyword">if</span> (store.getState()[<span class="string">'auth'</span>] &amp;&amp; store.getState()[<span class="string">'auth'</span>][<span class="string">'loginResult'</span>] &amp;&amp; store.getState()[<span class="string">'auth'</span>][<span class="string">'loginResult'</span>][<span class="string">'token'</span>]) &#123;</div><div class="line">        token = store.getState()[<span class="string">'auth'</span>][<span class="string">'loginResult'</span>][<span class="string">'token'</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.appRoot = token ? <span class="string">'tabs'</span> : <span class="string">'login'</span>;</div><div class="line">    renderType();</div><div class="line">    store.subscribe(onStoreUpdate)</div><div class="line">&#125;</div><div class="line"><span class="comment">//监听hotCheck变化 变true表示无需更新 重新流入token流程</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onStoreUpdateHot</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (store.getState()[<span class="string">'hot'</span>] &amp;&amp; store.getState()[<span class="string">'hot'</span>][<span class="string">'hotCheck'</span>]) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.appRoot === <span class="string">'hot'</span>) &#123;</div><div class="line">            checkToken();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//监听token变化切换root</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onStoreUpdate</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> token = <span class="literal">null</span>;</div><div class="line">    <span class="keyword">if</span> (store.getState()[<span class="string">'auth'</span>] &amp;&amp; store.getState()[<span class="string">'auth'</span>][<span class="string">'loginResult'</span>] &amp;&amp; store.getState()[<span class="string">'auth'</span>][<span class="string">'loginResult'</span>][<span class="string">'token'</span>]) &#123;</div><div class="line">        token = store.getState()[<span class="string">'auth'</span>][<span class="string">'loginResult'</span>][<span class="string">'token'</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">const</span> _appRoot = token ? <span class="string">'tabs'</span> : <span class="string">'login'</span>;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.appRoot !== _appRoot) &#123;</div><div class="line">        <span class="keyword">this</span>.appRoot = _appRoot;</div><div class="line">        renderType();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderType</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (<span class="keyword">this</span>.appRoot) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">"tabs"</span>:</div><div class="line">            Navigation.startTabBasedApp(&#123;</div><div class="line">                tabs: [...]</div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'login'</span>:</div><div class="line">            Navigation.startSingleScreenApp(&#123;</div><div class="line">                screen: &#123;</div><div class="line">                    screen: <span class="string">'login'</span>,</div><div class="line">                    ...</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'hot'</span>:</div><div class="line">            Navigation.startSingleScreenApp(&#123;</div><div class="line">                screen: &#123;</div><div class="line">                    screen: <span class="string">'hot'</span>,</div><div class="line">                    ...</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">"Error"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>检测到有更新包就进入hot这个root，这块儿就处理我们更新相关的逻辑，比如显示下载的进度，成功与否的提示之类的。checkForUpdate和sync这两个api可以详细看文档的解释，checkForUpdate是一个promise，返回了新包的相关参数，sync是触发更新的操作、可以监听整个流程。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">handleUpdate = <span class="keyword">async</span> () =&gt; &#123;</div><div class="line">       <span class="keyword">const</span> updateMessage = <span class="keyword">await</span> CodePush.checkForUpdate() || &#123;&#125;;</div><div class="line">       <span class="keyword">await</span> CodePush.sync(</div><div class="line">           <span class="comment">// 配置更新相关</span></div><div class="line">           &#123;</div><div class="line">               <span class="comment">// 安装模式 'IMMEDIATE' 立刻安装</span></div><div class="line">               installMode: CodePush.InstallMode.IMMEDIATE,</div><div class="line">               <span class="comment">// 强制更新模式</span></div><div class="line">               mandatoryInstallMode: CodePush.InstallMode.IMMEDIATE,</div><div class="line">               updateDialog: &#123;</div><div class="line">                   mandatoryUpdateMessage: <span class="string">'强制更新内容: '</span> + updateMessage.description,</div><div class="line">                   mandatoryContinueButtonLabel: <span class="string">'强制更新/确认'</span>,</div><div class="line">                   optionalIgnoreButtonLabel: <span class="string">'取消'</span>,</div><div class="line">                   optionalInstallButtonLabel: <span class="string">'安装'</span>,</div><div class="line">                   optionalUpdateMessage: <span class="string">'本次更新内容: '</span> + updateMessage.description,</div><div class="line">                   title: <span class="string">'发现新版本'</span></div><div class="line">               &#125;</div><div class="line">           &#125;,</div><div class="line">           <span class="comment">// 更新的状态监听</span></div><div class="line">           <span class="comment">//0 已是最新 1 安装完成等待生效 2 忽略更新 3 未知错误 4 已经在下载了 5 查询更新 6 弹出了更新确认界面 7 下载中 8下载完成</span></div><div class="line">           (status) =&gt; &#123;</div><div class="line">               <span class="built_in">console</span>.log(status)</div><div class="line">               <span class="keyword">switch</span> (status) &#123;</div><div class="line">                   <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">                       <span class="built_in">console</span>.log(<span class="string">'已经是最新版本'</span>);</div><div class="line">                       <span class="keyword">this</span>.props.setHot(<span class="literal">true</span>);</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   <span class="keyword">case</span> <span class="number">1</span> :</div><div class="line">                       <span class="built_in">console</span>.log(<span class="string">'更新完成, 再启动APP更新即生效'</span>);</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   <span class="keyword">case</span> <span class="number">3</span>:</div><div class="line">                       <span class="built_in">console</span>.log(<span class="string">'出错了，未知错误'</span>);</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   <span class="keyword">case</span> <span class="number">4</span>:</div><div class="line">                       <span class="built_in">console</span>.log(<span class="string">'已经在下载'</span>);</div><div class="line">                       <span class="keyword">this</span>.setState(&#123;updating: <span class="literal">true</span>&#125;)</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   <span class="keyword">case</span> <span class="number">7</span>:</div><div class="line">                       <span class="keyword">this</span>.setState(&#123;updating: <span class="literal">true</span>&#125;)</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   <span class="keyword">case</span> <span class="number">8</span>:</div><div class="line">                       <span class="keyword">this</span>.setState(&#123;updating: <span class="literal">false</span>&#125;)</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   <span class="keyword">default</span>:</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;,</div><div class="line">           <span class="comment">// 监听下载过程</span></div><div class="line">           (&#123; receivedBytes, totalBytes &#125;) =&gt; &#123;</div><div class="line">               <span class="keyword">this</span>.setState(&#123;</div><div class="line">                   receivedBytes: (receivedBytes / <span class="number">1024</span>).toFixed(<span class="number">2</span>),</div><div class="line">                   totalBytes: (totalBytes / <span class="number">1024</span>).toFixed(<span class="number">2</span>)</div><div class="line">               &#125;)</div><div class="line">           &#125;,</div><div class="line">       );</div><div class="line">   &#125;;</div></pre></td></tr></table></figure>
<h3 id="6-发布更新"><a href="#6-发布更新" class="headerlink" title="6 发布更新"></a>6 发布更新</h3><p>可以使用release-react这个简化命令发布更新代替使用release，但是所有的参数也是可以配置的，可以仔细读一下文档<a href="https://github.com/Microsoft/code-push/tree/master/cli#releasing-updates-react-native" target="_blank" rel="external">https://github.com/Microsoft/code-push/tree/master/cli#releasing-updates-react-native</a> 对每个参数都有解释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">code-push release-react &lt;appName&gt; &lt;platform&gt;</div><div class="line">[--bundleName &lt;bundleName&gt;]</div><div class="line">[--deploymentName &lt;deploymentName&gt;]</div><div class="line">[--description &lt;description&gt;]</div><div class="line">[--development &lt;development&gt;]</div><div class="line">[--disabled &lt;disabled&gt;]</div><div class="line">[--entryFile &lt;entryFile&gt;]</div><div class="line">[--gradleFile &lt;gradleFile&gt;]</div><div class="line">[--mandatory]</div><div class="line">[--noDuplicateReleaseError]</div><div class="line">[--outputDir &lt;outputDir&gt;]</div><div class="line">[--plistFile &lt;plistFile&gt;]</div><div class="line">[--plistFilePrefix &lt;plistFilePrefix&gt;]</div><div class="line">[--sourcemapOutput &lt;sourcemapOutput&gt;]</div><div class="line">[--targetBinaryVersion &lt;targetBinaryVersion&gt;]</div><div class="line">[--rollout &lt;rolloutPercentage&gt;]</div><div class="line">[--privateKeyPath &lt;pathToPrivateKey&gt;]</div><div class="line">[--config &lt;config&gt;]</div></pre></td></tr></table></figure>
<p>我项目里最后发布的命令如下是这样的，由于我使用的Production key，所以这边deploymentName也换成Production，默认是Staging，targetBinaryVersion不传的话默认会去android/gradle.properties下读，你的文件里没有的话就在命令里自己传进去。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//android</div><div class="line">code-push release-react androidApp android --deploymentName Production --targetBinaryVersion 1.0.1</div><div class="line">//ios</div><div class="line">code-push release-react iosApp ios --deploymentName Production --targetBinaryVersion 1.0.1</div></pre></td></tr></table></figure>
<p>CodePush.checkForUpdate()会检测对应当前版本的热更新包，比如你本地是1.0.3的包，传的是1.0.2的热更新包，.3是不会检测到这个更新的。更新包的时候可以打各种方式的版本，1.x.x之类的，可以细看文档描述。</p>
<p>发布后可以看下所有发布了包历史：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">code-push deployment history androidApp/iosApp Production</div></pre></td></tr></table></figure>
<p>会显示有多少个client安装了更新包</p>
<p>清除更新包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">code-push deployment clear androidApp/iosApp Production</div></pre></td></tr></table></figure>
<h3 id="碰到的问题"><a href="#碰到的问题" class="headerlink" title="碰到的问题"></a>碰到的问题</h3><p>测试的时候发现，下载好更新包后马上更新的内容是最新的，但是重启app的时候就自动rollback了，但是sync时却返回state为0，已经是最新的包了。后来在issue里找到类似的问题<a href="https://github.com/microsoft/react-native-code-push/issues/1564" target="_blank" rel="external">https://github.com/microsoft/react-native-code-push/issues/1564</a> 。在最外面一层加上CodePush.notifyAppReady()，通知一下。</p>
<blockquote>
<p>文档里是这样写notifyAppReady这个api的：<br>Notifies the CodePush runtime that an installed update is considered successful. If you are manually checking for and installing updates (i.e. not using the sync method to handle it all for you), then this method MUST be called; otherwise CodePush will treat the update as failed and rollback to the previous version when the app next restarts.</p>
</blockquote>
<p>虽然我们这边是使用的sync，按他的说法应该sync会自动做好这件事情，但是显然没有到达预期，所以手动加一下，重新测试发现的确解决了这个问题。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//我这边加在了每次进入app的check之前 (全部代码见上面5中)</span></div><div class="line">handleUpdate();</div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">handleUpdate</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">//这儿</span></div><div class="line">    CodePush.notifyAppReady();</div><div class="line">    <span class="keyword">const</span> updateMessage = <span class="keyword">await</span> CodePush.checkForUpdate() || &#123;&#125;;</div><div class="line">    <span class="keyword">if</span> (updateMessage &amp;&amp; !lodash.isEmpty(updateMessage)) &#123;</div><div class="line">        <span class="keyword">this</span>.appRoot = <span class="string">'hot'</span>;</div><div class="line">        renderType();</div><div class="line">        store.subscribe(onStoreUpdateHot)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        checkToken();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>官网：<a href="https://microsoft.github.io/code-push/" target="_blank" rel="external">https://microsoft.github.io/code-push/</a></p>
<p>CodePush client sdk文档：<a href="https://docs.microsoft.com/en-us/appcenter/distribution/codepush/react-native" target="_blank" rel="external">https://docs.microsoft.com/en-us/appcenter/distribution/codepush/react-native</a></p>
<p>各种别人的教程、经验分享：</p>
<p><a href="https://blog.csdn.net/w178191520/article/details/86361785" target="_blank" rel="external">https://blog.csdn.net/w178191520/article/details/86361785</a></p>
<p><a href="http://techblog.sishuxuefu.com/atricle.html?5beaa7e59f5454007039e01c" target="_blank" rel="external">http://techblog.sishuxuefu.com/atricle.html?5beaa7e59f5454007039e01c</a></p>
<p><a href="https://www.jianshu.com/p/6a5e00d22723" target="_blank" rel="external">https://www.jianshu.com/p/6a5e00d22723</a></p>
<p><a href="https://github.com/microsoft/react-native-code-push/issues/1564" target="_blank" rel="external">https://github.com/microsoft/react-native-code-push/issues/1564</a></p>
</div><div class="tags"><a href="/tags/react-native/">react-native</a></div><div class="post-nav"><a class="pre" href="/2019/12/31/cornerstone-sync/">cornerstone系列1 - cornerstoneTools的synchronize（同步化）</a><a class="next" href="/2019/04/21/webpacke-write/">手写webpack打包基础实现</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://huker.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/angular/" style="font-size: 15px;">angular</a> <a href="/tags/cornerstone/" style="font-size: 15px;">cornerstone</a> <a href="/tags/d3-js/" style="font-size: 15px;">d3.js</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/electron/" style="font-size: 15px;">electron</a> <a href="/tags/ionic/" style="font-size: 15px;">ionic</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/mocha/" style="font-size: 15px;">mocha</a> <a href="/tags/mongo/" style="font-size: 15px;">mongo</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/react-native/" style="font-size: 15px;">react-native</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/webpack/" style="font-size: 15px;">webpack</a> <a href="/tags/websocket/" style="font-size: 15px;">websocket</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/01/28/cornerstone-requestpool/">cornerstone系列2 - 预加载和request pool（请求池）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/31/cornerstone-sync/">cornerstone系列1 - cornerstoneTools的synchronize（同步化）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/16/rn-hot-update/">react-native热更新集成(使用CodePush)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/webpacke-write/">手写webpack打包基础实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/26/webpack-css/">webpack的css配置(模块化、抽离等)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/01/webpack4-guide/">webpack4指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/20/webpack2019note/">webpack2019笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/10/d3notes/">d3 - 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/29/hexoissues/">hexo遇到的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/01/ionic2-QA/">ionic2+开发 持续更新中</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/huker" title="GitHub" target="_blank">GitHub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">回头看看.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>